---
title: "Data Preparation"
author: "Alex J. Benecke"
date: "June 15, 2017"
output: pdf_document
header-includes:
    - \setlength\parindent{24pt}
    - \usepackage{indentfirst}
editor_options: 
  chunk_output_type: console
---
```{r Load Packages, include=FALSE}
library(FSA)
library(tidyverse)
library(stringr)
library(magrittr)

```
```{r Load Data}
LMB <- read.csv("Data/Raw-Data/2016_largemouth-bass_raw.csv") %>%
  dplyr::select(FID,Site,AgeCap:Sex) %>%
  arrange(FID)
```
```{r Quick Descriptive Stats}
str(LMB) ### n = 132
tmp <- LMB %>% filter(!is.na(AgeCap))
length(tmp$AgeCap) ### Aged fish = 127, not aged = 5
mean(tmp$AgeCap)
median(tmp$AgeCap)
range(tmp$AgeCap)
table(tmp$Sex)
```
```{r Clean Data}
### Making factors factors
LMB$FID <- factor(LMB$FID)
LMB$Site <- factor(LMB$Site)
LMB$SEXCON <- factor(LMB$SEXCON)
LMB$Sex <- factor(LMB$Sex)
str(LMB)

### Removing Outliers
length(LMB$FID)
LMB[LMB$FID==55,];FID55 <- as.numeric(rownames(LMB[LMB$FID==55,])) ### Data Entry Error
#LMB[LMB$FID==89,];FID89 <- as.numeric(rownames(LMB[LMB$FID==89,])) ### Unknown Sex > ezr model fitting
rm <- LMB[c(FID55),]; rm <- filterD(rm,!is.na(FID)) ### Create df containing removed fish
LMB <- LMB[-c(FID55),] %>%
  filterD(!is.na(FID)) ### Remove outliers
length(LMB$FID)
#write.csv(LMB,file="Data/Clean-Data/2016_largemouth-bass_clean.csv")
```

Now I need to put the data into one observation per line (long) format.

```{r Put Data into Long Format, tidy=TRUE}
LMBL <- gather(LMB,Agei,Radi,Anu1:Anu9) %>%
  arrange(FID,Agei)
```

  Next I will clean up the Agei variable so that it contains only numbers, is numeric, has no NA values, and is always less than or equal to the age-at-capture.

```{r Clean LMBL, tidy=TRUE}
str_sub(LMBL$Agei,start=1,end=3) <- ""
LMBL %<>% mutate(Agei=as.numeric(Agei)) %>%
  filterD(!is.na(Radi)) %>%
  filterD(Agei<=AgeCap)
```

  Next I will perform my back-calculation using the Biological-Intercept model. Where Otoloth radius at the time of formation ($O_{0}$) is 0.035 mm (Miller and Storck 1982) and the Length of the fish at time of otolith formation ($L_{0}$) is 3.9 mm (Heang 1982).

```{r Back-Calculation, tidy=TRUE}
LMBL$BI.len <- with(LMBL,LenCap+(Radi-RadCap)*(LenCap-3.9)*(RadCap-0.035)^-1)
```
```{r Create csv File Long Format, eval=FALSE}
#write.csv(LMBL,"Data/Clean-Data/2016_largemouth-bass_long-format.csv")
```

  I have commented out the final write.csv command because I do not want to accidently remake my data file.


## All Nearshore Data with Effort

```{r}
bio1 <- read.csv("Data/Raw-Data/Nearshore-Biodat_2013-2017.csv")%>%
  filterD(Year<2017)

str(bio1)
```
```{r Load Effort Data}
eff1 <- read.csv("Data/Raw-Data/Effort-Nearshore_2013-2017.csv") %>%
  arrange(Year,Site) %>%
  filterD(!is.na(STARTTIME)) %>%
  filterD(Year<2017)
```
```{r Create effort variable sum by site and year}
### create Effort variable (Seconds)
eff1$effort.s <- eff1$ENDTIME-eff1$STARTTIME
eff1$effort.min <- (eff1$ENDTIME-eff1$STARTTIME)/60
eff1$effort.hr <- (eff1$effort.min)/60

eff <- eff1 %>% group_by(Year,Site) %>%
  summarize(effort = sum(effort.hr))

str(eff)
headtail(eff)
```

**Note:**
  
  *There is no effort data for Sites 11 and 12 during 2013. I will need to throw out fish from sites 11 and 12 during 2013. Also, there is no effort data for 2017*


```{r Summarize number fish by species site and year}
bio <- bio1 %>% group_by(Year,Site,Species) %>%
  summarize(catch=n()) %>%
  as.data.frame()

### remove sites 11 and 12 from 2013
unique(bio$Site[bio$Year==2013])

(rm.site.11.2013 <- as.numeric(rownames(bio[bio$Year==2013 & bio$Site==11,])))

(rm.site.12.2013 <- as.numeric(rownames(bio[bio$Year==2013 & bio$Site==12,])))

(rm <- c(rm.site.11.2013, rm.site.12.2013))

bio <- bio[-rm,] %>%
  filterD(!is.na(Site))

unique(bio$Site[bio$Year==2013])
```

```{r}
headtail(bio)
headtail(eff)
```

**Note:**

  *It looks like I have effort data for site 19 from 2016 but no fish. Add Zeros*

```{r}
(yr.13.bio <- unique(bio$Site[bio$Year==2013])) ### Site 19 missing in Bio
(yr.13.eff <- unique(eff$Site[eff$Year==2013]))

(yr.14.bio <- unique(bio$Site[bio$Year==2014]))
(yr.14.eff <- unique(eff$Site[eff$Year==2014]))

(yr.15.bio <- unique(bio$Site[bio$Year==2015]))
(yr.15.eff <- unique(eff$Site[eff$Year==2015]))

(yr.16.bio <- unique(bio$Site[bio$Year==2016])) ### Site 19 missing in Bio
(yr.16.eff <- unique(eff$Site[eff$Year==2016]))
```
  
  
  
```{r}
catch <- left_join(eff,bio,by=c("Year","Site"))

#catch$UID <- paste0(catch$Year,sep=".",catch$Site)

headtail(catch)
```

```{r}
catch %<>% addZeroCatch("Site","Species", zerovar = "catch") %>%
  arrange(Year,Site)

headtail(catch)
```







```{r Summarize number fish by species site and year}
tmp <- bio %>% group_by(Year,Site,Species) %>%
  summarize(catch=n()) %>%
  as.data.frame()

headtail(tmp)

### summaries for length for species site and year
tmp <- bio %>% group_by(Year,Site,Species) %>%
  summarize(n = n(), val.n = validn(Length),
            mean = round(mean(Length,na.rm = TRUE),1),
            sd = round(sd(Length,na.rm = TRUE),2),
            min = min(Length,na.rm = TRUE),
            mdn = quantile(Length, 0.5, na.rm = TRUE),
            max = max(Length,na.rm = TRUE)) %>%
  as.data.frame()

headtail(tmp)
```

















