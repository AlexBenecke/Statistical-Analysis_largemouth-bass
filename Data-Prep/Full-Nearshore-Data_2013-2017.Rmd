---
title: "Full Nearshore Data 2013 - 2017 (CPUE)"
author: "Alex J. Benecke"
date: "January 30, 2018"
output: pdf_document
header-includes:
    - \setlength\parindent{24pt}
    - \usepackage{indentfirst}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(FSA)
library(tidyverse)
library(stringr)
library(magrittr)
```



## All Nearshore Data with Effort

  So I want to calculate CPUE for each site and year and species (Although I'm Mainly interested in largemouth bass Species code = 317). I went through the data sheets for 2013 and entered weights so I will also want to use this data file for the Wr analysis. I am excluding year 2017 because it was sampled with a different crew different gear and posibly different methods (Data looks like nothing I've seen in previous years so i just don't trust it). 
  
  catch %<>% addZeroCatch("Site","Species", zerovar = "caught") %>%
  arrange(Year,Site)
  

```{r Load Bio Data}
bio1 <- read.csv("Data/Raw-Data/Nearshore-Biodat_2013-2017.csv")%>%
  filterD(Year<2017)

str(bio1)
headtail(bio1)
```
```{r Load Effort Data}
eff1 <- read.csv("Data/Raw-Data/Effort-Nearshore_2013-2017.csv") %>%
  arrange(Year,Site) %>%
  filterD(!is.na(STARTTIME)) %>%
  filterD(Year<2017)
```
```{r Create effort variable sum by site and year}
### create Effort variable (Seconds)
eff1$effort.s <- eff1$ENDTIME-eff1$STARTTIME
eff1$effort.min <- (eff1$ENDTIME-eff1$STARTTIME)/60
eff1$effort.hr <- (eff1$effort.min)/60

### Using efishing Hours
eff <- eff1 %>% group_by(Year,Site) %>%
  summarize(effort = sum(effort.hr))

str(eff)
headtail(eff)
```

**Note:**
  
  *There is no effort data for Sites 11 and 12 during 2013.*
```{r show no effort from sites 11 and 12 during 2013}
(Note1 <- eff[eff$Year==2013,] %>%
  as.data.frame());print("2013 Sites");unique(Note1$Site);print("Sites 11 & 12 are Missing")
```
  *I will need to throw out fish from sites 11 and 12 during 2013.* 
```{r Show fish from sites 11 and 12 during 2013 to be removed}
Note2 <- bio1[bio1$Year==2013 & bio1$Species==317,] %>%
   as.data.frame()
(Note2 <- Note2[Note2$Site == 11 | Note2$Site == 12,])[,c(4:7,11)]
print("No largemouth bass from site 12")
print("Number of largemouth bass in site 11");nrow(Note2)
```
  **This will remove 7 LMB from Site 11 in 2013.** *Also, there is no effort data for 2017*


```{r Summarize number fish by species site and year}
bio <- bio1 %>% group_by(Year,Site,Species) %>%
  summarize(caught = sum(Count)) %>%
  as.data.frame()

### remove sites 11 and 12 from 2013
unique(bio$Site[bio$Year==2013])

(rm.site.11.2013 <- as.numeric(rownames(bio[bio$Year==2013 & bio$Site==11,])))

(rm.site.12.2013 <- as.numeric(rownames(bio[bio$Year==2013 & bio$Site==12,])))

(rm <- c(rm.site.11.2013, rm.site.12.2013))

bio <- bio[-rm,] %>%
  filterD(!is.na(Site))

unique(bio$Site[bio$Year==2013])
```

```{r}
headtail(bio)
headtail(eff)
```

**Note:**

  *It looks like I have effort data for site 19 from 2016 and 2013 but no fish. It must be that only non sport fish were caugth at site 19 so there is no length data. Add Zeros later in document.* 

```{r Check Sites are same for bio and eff every year, eval=FALSE,include=FALSE}
(yr.13.bio <- unique(bio$Site[bio$Year==2013])) ### Site 19 missing in Bio
(yr.13.eff <- unique(eff$Site[eff$Year==2013]))

(yr.14.bio <- unique(bio$Site[bio$Year==2014]))
(yr.14.eff <- unique(eff$Site[eff$Year==2014]))

(yr.15.bio <- unique(bio$Site[bio$Year==2015]))
(yr.15.eff <- unique(eff$Site[eff$Year==2015]))

(yr.16.bio <- unique(bio$Site[bio$Year==2016])) ### Site 19 missing in Bio
(yr.16.eff <- unique(eff$Site[eff$Year==2016]))
```
  
  
```{r Join eff and bio data}
catch <- left_join(eff, bio,by=c("Year","Site")) %>%
  as.data.frame()

#catch$UID <- paste0(catch$Year,sep=".",catch$Site)

headtail(catch)
str(catch) # Needs to be data frame
```

```{r Add zeros for species not caught}
catch %<>% addZeroCatch("Site","Species", zerovar = "caught") %>%
  arrange(Year,Site)

headtail(catch) ### Here are the zeroes for site 19 2013 and 2016 problem resolved
```


```{r Make CPUE variable Catch / hr efishing}
catch %<>% mutate(cpe.hr = caught/effort)

headtail(catch)

#2-7-2018#write.csv(catch,"Data/Clean-Data/CPUE_2013-2016.csv",row.names = FALSE)
```

```{r Summarize CPUE}
cpeSum <- catch %>% group_by(Year,Species) %>%
  summarize(samples = n(), fish = sum(caught),
            mean = mean(cpe.hr), sd = sd(cpe.hr),
            se = sd/sqrt(samples), RSE = se/mean*100) %>%
  as.data.frame()

cpeSum
#2-7-2018#write.csv(cpeSum,"Data/Clean-Data/summary-data/cpeSum.csv",row.names = FALSE)
```


  So this is usefull but what I really want is just largemouth bass with lengths weights and effort.
  
  
  
```{r Remove sites 11 and 12 from 2013 for bio2}
headtail(bio1)

bio2 <- bio1

bio2$Sp.Name <- numeric(nrow(bio2))
headtail(bio2)

for(i in 1:nrow(bio2)){
  if(bio2$Species[i] == 41){
  bio2$Sp.Name[i] = "Longnose Gar"
} else if(bio2$Species[i] == 171){
  bio2$Sp.Name[i] = "Shorthead Redhorse"
} else if(bio2$Species[i] == 201){
  bio2$Sp.Name[i] = "Spottail Shiner"
} else if(bio2$Species[i] == 203){
  bio2$Sp.Name[i] = "Spotfin Shiner"
} else if(bio2$Species[i] == 301){
  bio2$Sp.Name[i] = "White Perch"
} else if(bio2$Species[i] == 302){
  bio2$Sp.Name[i] = "White Bass"
} else if(bio2$Species[i] == 311){
  bio2$Sp.Name[i] = "Rock Bass"
} else if(bio2$Species[i] == 312){
  bio2$Sp.Name[i] = "Green Sunfish"
} else if(bio2$Species[i] == 313){
  bio2$Sp.Name[i] = "Pumpkinseed"
} else if(bio2$Species[i] == 314){
  bio2$Sp.Name[i] = "Bluegill"
} else if(bio2$Species[i] == 316){
  bio2$Sp.Name[i] = "Smallmouth Bass"
} else if(bio2$Species[i] == 317){
  bio2$Sp.Name[i] = "Largemouth Bass"
} else if(bio2$Species[i] == 319){
  bio2$Sp.Name[i] = "Black Crappie"
} else if(bio2$Species[i] == 324){
  bio2$Sp.Name[i] = "Orangespotted Sunfish"
} else if(bio2$Species[i] == 331){
  bio2$Sp.Name[i] = "Yellow Perch"
} else if(bio2$Species[i] == 334){
  bio2$Sp.Name[i] = "Walleye"
} else if(bio2$Species[i] == 342){
  bio2$Sp.Name[i] = "Logperch"
} else if(bio2$Species[i] == 702){
  bio2$Sp.Name[i] = "Pumpkinseed Bluegill Hybrid"
} else{
  bio2$Sp.Name[i] = "Green Sunfish Bluegill Hybrid"
}
}


bio2 %<>% mutate(lcat20 = lencat(Length, w = 20)) %>%
  mutate(lcat10 = lencat(Length, w = 10)) %>%
  mutate(gcat = psdAdd(Length, Sp.Name))

gcat.bio <- bio2 %>% group_by(Year, Site, Species, gcat) %>%
  summarize(caught = sum(Count)) %>%
  as.data.frame()

headtail(gcat.bio) # nrow = 4788
str(gcat.bio)

unique(gcat.bio$Species)

(tmp <- gcat.bio[gcat.bio$Year==2016 & gcat.bio$Site==18,] %>% arrange(Site,Species))

unique(tmp$Species)


```


**Note:**
  *No Gabelhouse length category data for Green Sunfish Bluegill Hybrid, Logperch, Orangespotted Sunfish, Pumpkinsee Bluegill Hybrid, Spotfin Shiner, Spottail Shiner. This seems obvious but is good to take note of. Im going to go back and remove those species*

```{r}
### remove sites 11 and 12 from 2013
unique(gcat.bio$Site[gcat.bio$Year==2013])

(rm2.site.11.2013 <- as.numeric(rownames(gcat.bio[gcat.bio$Year==2013 & gcat.bio$Site==11,])))

(rm2.site.12.2013 <- as.numeric(rownames(gcat.bio[gcat.bio$Year==2013 & gcat.bio$Site==12,])))

(rm2 <- c(rm2.site.11.2013, rm2.site.12.2013))

print("Rows to remove n =");length(rm2)

gcat.bio <- gcat.bio[-rm2,] %>%
  filterD(!is.na(Site))

unique(gcat.bio$Site[gcat.bio$Year==2013])

### Remove Sp without Gcat data
(sp.list <- unique(gcat.bio$Species) %>% sort())

(rm.sp <- c(as.numeric(row.names(gcat.bio[gcat.bio$Species==705,])),
                     as.numeric(row.names(gcat.bio[gcat.bio$Species==702,])),
                     as.numeric(row.names(gcat.bio[gcat.bio$Species==342,])),
                     as.numeric(row.names(gcat.bio[gcat.bio$Species==324,])),
                     as.numeric(row.names(gcat.bio[gcat.bio$Species==203,])),
                     as.numeric(row.names(gcat.bio[gcat.bio$Species==201,]))))

gcat.bio[rm.sp,c(2,3)]

unique(gcat.bio$Species[rm.sp])

print("Rows to remove n =");length(rm.sp)

print("Total rows to remove");length(rm2)+length(rm.sp)


gcat.bio <- gcat.bio[-rm.sp,] %>%
  filterD(!is.na(Species))

(sp.list <- unique(gcat.bio$Species) %>% sort())

unique(gcat.bio$Site[gcat.bio$Year==2013])
```


```{r Make new effort object eff2}
headtail(eff)
```

```{r merge eff2 and bio2}
cpe <- left_join(eff, gcat.bio, by=c("Year","Site")) %>%
  as.data.frame()

headtail(cpe)
str(cpe)
```


```{r Add zeros for species by site}

cpe %<>% addZeroCatch("Site","Species", zerovar = "caught") %>%
  arrange(Year,Site)

cpe$ID <- paste(cpe$Year,".",cpe$Site,",",cpe$Species)

cpe %<>% addZeroCatch("ID","gcat", zerovar = "caught") %>%
  arrange(Year,Site)
  
cpe %<>% select(Year:caught)

```
```{r}
str(cpe)
headtail(cpe) # nrow = 3132


(tmp <- cpe[cpe$Year==2016,] %>% arrange(Site,Species,gcat))
(tmp <- cpe[cpe$Year==2016,] %>% arrange(gcat))

(tmp2 <- tmp[tmp$Site==18,])

### Missing
### Substock 314
(unique(tmp2$Species) %>% sort())
tmp[tmp$Site==18 & tmp$gcat=="substock",] %>% arrange(gcat,Species)

### Stock All present
(unique(tmp2$Species) %>% sort())
tmp[tmp$Site==18 & tmp$gcat=="stock",] %>% arrange(gcat,Species)

### Quality 314
length(unique(tmp2$Species)) - nrow(tmp[tmp$Site==18 & tmp$gcat=="quality",])

(unique(tmp2$Species) %>% sort())
tmp[tmp$Site==18 & tmp$gcat=="quality",] %>% arrange(gcat,Species)

### preferred 314
length(unique(tmp2$Species)) - nrow(tmp[tmp$Site==18 & tmp$gcat=="preferred",])

(unique(tmp2$Species) %>% sort())
tmp[tmp$Site==18 & tmp$gcat=="preferred",] %>% arrange(gcat,Species)

### memorable 302,334,41
length(unique(tmp2$Species)) - nrow(tmp[tmp$Site==18 & tmp$gcat=="memorable",])

(unique(tmp2$Species) %>% sort())
tmp[tmp$Site==18 & tmp$gcat=="memorable",] %>% arrange(gcat,Species)

### trophy 302,334,41
length(unique(tmp2$Species)) - nrow(tmp[tmp$Site==18 & tmp$gcat=="trophy",])

(unique(tmp2$Species) %>% sort())
tmp[tmp$Site==18 & tmp$gcat=="trophy",] %>% arrange(gcat,Species)

(unique(tmp$Species) %>% sort())
```



```{r , include=FALSE}
headtail(cpe)
str(cpe)
#2-8-2018#write.csv(cpe,"Data/Clean-Data/CPUE-gcat_2013-2016.csv",row.names = FALSE)
```

